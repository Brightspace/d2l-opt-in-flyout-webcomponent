<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

		<title>d2l-opt-out-flyout test</title>

		<script src="../../@webcomponents/webcomponentsjs/webcomponents-bundle.js"></script>
		<script src="../../wct-browser-legacy/browser.js"></script>
		<script src="../../@polymer/iron-test-helpers/mock-interactions.js" type="module"></script>

		<script type="module" src="../d2l-opt-out-flyout.js"></script>
	</head>
	<body>
		<test-fixture id="FlyoutEmptyFixture">
			<template>
				<d2l-opt-out-flyout
					open
				></d2l-opt-out-flyout>
			</template>
		</test-fixture>
		<test-fixture id="FlyoutPropertiesFixture">
			<template>
				<d2l-opt-out-flyout
					open
					title="Flyout Demo"
					short-description="This is a short description"
					long-description="This is a long description"
					tab-position="right"
					tutorial-link="https://www.testlink1.com"
					help-docs-link="https://www.testlink2.com"
				></d2l-opt-out-flyout>
			</template>
		</test-fixture>
		<test-fixture id="FlyoutEmptyClosedFixture">
			<template>
				<d2l-opt-out-flyout
				></d2l-opt-out-flyout>
			</template>
		</test-fixture>
		<script type="module">
import '../d2l-opt-out-flyout.js';
import { afterNextRender } from '@polymer/polymer/lib/utils/render-status.js';
import { dom } from '@polymer/polymer/lib/legacy/polymer.dom.js';
import TestUtil from './test-util.js';
describe('<d2l-opt-out-flyout>', function() {
	describe('when properties use default values', function() {

		var flyout, innerFlyout;

		beforeEach(function(done) {
			flyout = fixture('FlyoutEmptyFixture');
			innerFlyout = flyout.shadowRoot.querySelector('flyout-impl');
			afterNextRender(innerFlyout, done);
		});

		it('should contain short description', function() {
			var shortDescription = innerFlyout.$$('#short-description');
			expect(shortDescription.hidden).to.be.true;
		});

		it('should not contain title', function() {
			var title = innerFlyout.$$('#title');
			expect(title.textContent).to.equal(' ');
		});

		it('should not contain long description', function() {
			var longDescription = innerFlyout.$$('#long-description');
			expect(longDescription.hidden).to.be.true;
		});

		it('should not contain tutorial link or help documentation if not set', function(done) {
			afterNextRender(flyout, function() {
				var tutorial = innerFlyout.$$('.flyout-tutorial');
				var links = TestUtil.selectVisible(tutorial, 'a');

				expect(links.length).to.equal(0);

				done();
			});
		});

		it('should not display reason dialog', function() {
			var dialog = innerFlyout.$$('opt-out-dialog');
			expect(dialog).to.equal(null);
		});
	});

	describe('when properties are specified', function() {
		var flyout, innerFlyout;

		beforeEach(function(done) {
			flyout = fixture('FlyoutPropertiesFixture');
			innerFlyout = flyout.shadowRoot.querySelector('flyout-impl');
			afterNextRender(innerFlyout, done);
		});

		it('should contain short description', function() {
			var shortDescription = innerFlyout.$$('#short-description');
			expect(shortDescription.hidden).to.be.false;
			var content = dom(innerFlyout.root).querySelector('#short-description s-html').shadowRoot;
			expect(content.textContent).to.equal('This is a short description');
		});

		it('should contain title', function() {
			var title = innerFlyout.$$('#title');
			expect(title.textContent).to.equal('Flyout Demo');
		});

		it('should reflect title attribute to property', function() {
			var newTitle = 'new title';

			flyout.setAttribute('title', newTitle);
			expect(flyout.title).to.equal(newTitle);
			var title = flyout.shadowRoot.querySelector('flyout-impl').$$('#title');
			expect(title.textContent).to.equal(newTitle);
		});

		it('should contain long description', function() {
			var longDescription = innerFlyout.$$('#long-description');
			expect(longDescription.hidden).to.be.false;
			var content = dom(innerFlyout.root).querySelector('#long-description s-html').shadowRoot;
			expect(content.textContent).to.equal('This is a long description');
		});

		it('should contain tutorial link', function(done) {
			afterNextRender(flyout, function() {
				var tutorial = innerFlyout.$$('.flyout-tutorial');
				var links = TestUtil.selectVisible(tutorial, 'a');

				expect(links.length).to.equal(2);

				expect(links[0].href).to.contain('https://www.testlink1.com');
				expect(links[0].textContent).to.contain('tutorials');

				done();
			});
		});

		it('should contain help documentation link', function(done) {
			afterNextRender(flyout, function() {
				var tutorial = innerFlyout.$$('.flyout-tutorial');
				var links = TestUtil.selectVisible(tutorial, 'a');

				expect(links.length).to.equal(2);

				expect(links[1].href).to.contain('https://www.testlink2.com');
				expect(links[1].textContent).to.contain('help documentation');

				done();
			});
		});

		it('should contain only tutorial specific text when only tutorial link specified', function(done) {
			innerFlyout.helpDocsLink = null;
			afterNextRender(flyout, function() {
				var tutorial = innerFlyout.$$('.flyout-tutorial');
				var links = TestUtil.selectVisible(tutorial, 'a');

				expect(links.length).to.equal(1);

				expect(links[0].href).to.contain('https://www.testlink1.com');
				expect(links[0].textContent).to.contain('tutorials');

				done();
			});
		});

		it('should contain only help documentation specific text when only help link specified', function(done) {
			innerFlyout.tutorialLink = null;
			afterNextRender(flyout, function() {
				var tutorial = innerFlyout.$$('.flyout-tutorial');
				var links = TestUtil.selectVisible(tutorial, 'a');

				expect(links.length).to.equal(1);

				expect(links[0].href).to.contain('https://www.testlink2.com');
				expect(links[0].textContent).to.contain('help documentation');

				done();
			});
		});

		it('should contain enable button', function() {
			var button = innerFlyout.$$('d2l-button[primary]');
			expect(button.textContent).to.equal('Leave it on');
			expect(button).to.exist;
		});

		it('should contain turn it off button', function() {
			var button = innerFlyout.$$('d2l-button:not([primary])');
			expect(button.textContent).to.equal('Turn it off');
			expect(button).to.exist;
		});

		it('should fire opt-in event when "leave it on" button clicked', function(done) {
			flyout.addEventListener('opt-in', function() {
				done();
			});

			var button = innerFlyout.$$('d2l-button[primary]');
			MockInteractions.tap(button);
		});

		it('should fire flyout-closed event when "leave it on" button clicked and not display dialog', function(done) {
			flyout.addEventListener('flyout-closed', function() {
				var dialog = innerFlyout.$$('opt-out-dialog');
				expect(dialog).to.not.exist;
				done();
			});

			var button = innerFlyout.$$('d2l-button[primary]');
			MockInteractions.tap(button);
		});

		it('should open reason dialog when "turn it off" button clicked', function(done) {
			var button = innerFlyout.$$('d2l-button:not([primary])');
			MockInteractions.tap(button);

			afterNextRender(flyout, function() {
				var dialog = innerFlyout.$$('opt-out-dialog');
				expect(dialog).to.exist;
				done();
			});
		});

		it('should fire flyout-closed event when tab clicked', function(done) {
			flyout.addEventListener('flyout-closed', function() {
				done();
			});

			var tab = innerFlyout.$$('.flyout-tab');
			MockInteractions.tap(tab);
		});
	});

	describe('when flyout is closed', function() {
		it('should fire flyout-opened event when tab clicked', function(done) {
			var flyout = fixture('FlyoutEmptyClosedFixture');
			flyout.addEventListener('flyout-opened', function() {
				done();
			});

			var tab = flyout.shadowRoot.querySelector('flyout-impl').$$('.flyout-tab');
			MockInteractions.tap(tab);
		});
	});
});
</script>
	</body>
</html>
