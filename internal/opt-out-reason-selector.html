<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../d2l-inputs/d2l-input-shared-styles.html">
<link rel="import" href="../d2l-opt-out-reason.html">
<link rel="import" href="./translate-behaviour.html">

<dom-module id="opt-out-reason-selector">
	<template strip-whitespace>
		<style include="d2l-input-styles">
			select {
				@apply --d2l-input;
				appearance: none;
				-moz-appearance: none;
				-webkit-appearance: none;
				background-image: url("data:image/svg+xml,%3Csvg%20width%3D%2242%22%20height%3D%2242%22%20viewBox%3D%220%200%2042%2042%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20fill%3D%22%23f2f3f5%22%20d%3D%22M0%200h42v42H0z%22%2F%3E%3Cpath%20stroke%3D%22%23d3d9e3%22%20d%3D%22M0%200v42%22%2F%3E%3Cpath%20d%3D%22M14.99%2019.582l4.95%204.95a1.5%201.5%200%200%200%202.122%200l4.95-4.95a1.5%201.5%200%200%200-2.122-2.122L21%2021.35l-3.888-3.89a1.5%201.5%200%200%200-2.12%202.122z%22%20fill%3D%22%23565A5C%22%2F%3E%3C%2Fsvg%3E");
				background-position: right center;
				background-repeat: no-repeat;
				background-size: contain;
				display: block;
				margin-bottom: 1.5rem;
				position: relative;
				width: 80%;
			}

			/* for ie11 - avoid displaying default select arrow */
			select::-ms-expand {
				display: none;
			}

			:dir(rtl) select {
				background-position: left center;
			}

			/* IE11 and edge */
			:host([dir="rtl"]) select {
				background-position: left center;
			}

			select:hover, select:focus {
				@apply --d2l-input-hover-focus;
			}

			#options {
				display: none;
			}
		</style>
		<select id="selector" on-change="_reasonSelected">
			<option disabled value="">[[translate('Feedback.ChooseReason')]]</option>
			<!-- elements generated from [[_reasons]] go here -->
			<option value="Other">[[translate('Feedback.Reason.Other')]]</option>
		</select>
		<div id="options">
			<slot id="options-slot" on-slotchange="_onSlotChanged"></slot>
		</div>
	</template>
	<script>
		'use strict';

		Polymer({
			is: 'opt-out-reason-selector',

			properties: {
				selected: {
					type: String,
					readOnly: true,
					reflectToAttribute: true,
					notify: true,
					value: null
				},
				_reasons: {
					type: Array,
					value: [],
					observer: '_reasonsChanged'
				}
			},

			behaviors: [
				D2L.PolymerBehaviors.OptInFlyout.TranslateBehavior
			],

			attached: function() {
				// Polymer 1 compatability
				if( this.$['options-slot'].tagName !== 'SLOT' ) {
					this._observer = Polymer.dom( this.$.options ).observeNodes( this._onSlotChanged.bind( this ) );
					this._onSlotChanged();
				} else {
					// This is required for Safari to work correctly.
					this._onSlotChanged();
				}
			},

			detached: function() {
				// Polymer 1 compatability
				if( this._observer && this.$['options-slot'].tagName !== 'SLOT' ) {
					Polymer.dom( this.$.options ).unobserveNodes( this._observer );
				}
			},

			_onSlotChanged: function() {
				/* Passing <option> elements directly into a <select> tag with a slot doesn't work.
				 * Instead, pass in <d2l-opt-out-reason> elements, and this component will construct
				 * the options from the passed in options.
				 */

				this.$.selector.selectedIndex = 0;
				var children = [];

				if( this.$['options-slot'].tagName === 'SLOT' ) {
					// Polymer 2
					children = this.$['options-slot'].assignedNodes({ flatten: true });
				} else {
					// Polymer 1
					children = Polymer.dom( this.$.options ).getEffectiveChildNodes();
				}

				children = children.filter( function( child ) {
					return child && child.tagName === 'D2L-OPT-OUT-REASON' && child.key && child.text;
				}).map( function( child ) {
					return {
						key: child.key,
						text: child.text
					};
				});

				if( children.length <= 0 ) {
					// Use default options if no valid options were provided
					children = [
						{ key: 'PreferOldExperience', text: this.translate( 'Feedback.Reason.PreferOldExperience' ) },
						{ key: 'MissingFeature', text: this.translate( 'Feedback.Reason.MissingFeature' ) },
						{ key: 'NotReadyForSomethingNew', text: this.translate( 'Feedback.Reason.NotReadyForSomethingNew' ) },
						{ key: 'JustCheckingSomething', text: this.translate( 'Feedback.Reason.JustCheckingSomething' ) }
					];
				}

				this._reasons = [];
				this._reasons = children;
			},

			_reasonSelected: function( event ) {
				var selectionIndex = this.$.selector.selectedIndex;
				if( selectionIndex < 1 ) {
					this._setSelected( null );
					return;
				}

				var selection = this.$.selector.options[selectionIndex];
				if( !selection || !selection.value ) {
					this._setSelected( null );
					return;
				}

				this._setSelected( selection.value );
			},

			_reasonsChanged: function( reasons ) {
				// [Workaround] dom-repeat inside a <select> element doesn't work in IE11
				var selectElement = this.$.selector;
				while( selectElement.childNodes.length > 2 ) {
					selectElement.removeChild( selectElement.childNodes[1] );
				}

				reasons.forEach( function( reason ) {
					var option = document.createElement( 'option' );
					option.value = reason.key;
					option.textContent = reason.text;
					selectElement.insertBefore( option, selectElement.lastChild );
				});
			}

		});
	</script>
</dom-module>
