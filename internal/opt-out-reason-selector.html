<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../d2l-text-input/d2l-text-input-shared-styles.html">
<link rel="import" href="../d2l-opt-out-reason.html">
<link rel="import" href="./translate-behaviour.html">

<dom-module id="opt-out-reason-selector">
	<template strip-whitespace>
		<style>
			select {
				@apply --d2l-input;
				position: relative;
				display: block;
				width: 80%;
				margin-bottom: 1.5rem;
			}
			
			select:hover, select:focus {
				@apply --d2l-input-hover;
			}
			
			#options {
				display: none;
			}
		</style>
		<select id="selector" on-change="_reasonSelected">
			<option disabled value="">[[translate('Feedback.ChooseReason')]]</option>
			<!-- element generated from [[_reasons]] go here -->
			<option value="Other">[[translate('Feedback.Reason.Other')]]</option>
		</select>
		<div id="options">
			<slot on-slotchange="_onSlotChanged"></slot>
		</div>
	</template>
	<script>
		'use strict';
		
		Polymer({
			is: 'opt-out-reason-selector',
			
			properties: {
				selected: {
					type: String,
					readOnly: true,
					reflectToAttribute: true,
					notify: true,
					value: null
				},
				_reasons: {
					type: Array,
					value: [],
					observer: '_reasonsChanged'
				}
			},
			
			behaviors: [
				D2L.PolymerBehaviors.OptInFlyout.TranslateBehavior
			],
			
			attached: function() {
				// Polymer 1 compatability
				if( !Polymer.FlattenedNodesObserver ) {
					this._observer = Polymer.dom( this.$.options ).observeNodes( this._onSlotChanged.bind( this ) );
					this._onSlotChanged();
				}
			},
			
			detached: function() {
				// Polymer 1 compatability
				if( this._observer && !Polymer.FlattenedNodesObserver ) {
					Polymer.dom( this.$.options ).unobserveNodes( this._observer );
				}
			},
			
			_onSlotChanged: function() {
				/* Passing <option> elements directly into a <select> tag with a slot doesn't work.
				 * Instead, pass in <d2l-opt-out-reason> elements, and this component will construct
				 * the options from the passed in options.
				 */
				
				this.$.selector.selectedIndex = 0;
				var children = [];
				
				if( Polymer.FlattenedNodesObserver ) {
					// Polymer 2
					children = Polymer.FlattenedNodesObserver.getFlattenedNodes( this.$.options )
				} else {
					// Polymer 1
					children = Polymer.dom( this.$.options ).getEffectiveChildNodes();
				}
				
				children = children.filter( function( child ) {
					return child && child.tagName === 'D2L-OPT-OUT-REASON' && child.key && child.text;
				}).map( function( child ) {
					return {
						key: child.key,
						text: child.text
					};
				});
				
				if( children.length <= 0 ) {
					// Use default options if no valid options were provided
					children = [
						{ key: 'NotReadyForSomethingNew', text: this.translate( 'Feedback.Reason.NotReadyForSomethingNew' ) },
						{ key: 'MissingFeature', text: this.translate( 'Feedback.Reason.MissingFeature' ) },
						{ key: 'JustCheckingSomething', text: this.translate( 'Feedback.Reason.JustCheckingSomething' ) }
					];
				}
				
				this._reasons = [];
				this._reasons = children;
			},
			
			_reasonSelected: function( event ) {
				var selectionIndex = this.$.selector.selectedIndex;
				if( selectionIndex < 1 ) {
					this._setSelected( null );
					return;
				}
				
				var selection = this.$.selector.options[selectionIndex];
				if( !selection || !selection.value ) {
					this._setSelected( null );
					return;
				}
				
				this._setSelected( selection.value );
			},
			
			_reasonsChanged: function( reasons ) {
				// [Workaround] dom-repeat inside a <select> element doesn't work in IE11
				var selectElement = this.$.selector;
				while( selectElement.childNodes.length > 2 ) {
					selectElement.removeChild( selectElement.childNodes[1] );
				}
				
				reasons.forEach( function( reason ) {
					var option = document.createElement( 'option' );
					option.value = reason.key;
					option.textContent = reason.text;
					selectElement.insertBefore( option, selectElement.lastChild );
				});
			}
			
		});
	</script>
</dom-module>
